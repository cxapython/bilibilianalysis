<div id="output_wrapper_id" class="output_wrapper" style="font-size: 16px; color: #3e3e3e; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; font-family: 'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;">
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">数据分析|改革春风吹满地火在哪里</p>
<blockquote style="line-height: inherit; display: block; padding: 15px 15px 15px 1rem; font-size: 0.9em; margin: 1em 0px; color: #819198; border-left: 6px solid #dce6f0; background: #f2f7fb; overflow: auto; overflow-wrap: normal; word-break: normal;">
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0px;">改革春风吹满地，中国人民真争气。</p>
</blockquote>
<img style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; display: block; margin: 0px auto; max-width: 100%;" title="" src="https://img2018.cnblogs.com/blog/736399/201901/736399-20190102202206498-354373643.png" alt="" /><br />2018年年末，&ldquo;改革春风吹满地&rdquo;火了。这是一个来自哔哩哔哩的一个鬼畜类音乐视频。<br />由up主小可儿上传，目前播放量已达到1400多万，有着相当高的热度。该视频剪辑了赵本山的历年作品的经典台词，配以略带喜感的音乐(bgm由其他up主制作),每一句台词衔接的相当完美。在网易云音乐里也可以搜到同名音乐,另有别名「念诗之王」正常,网易云的一位<br />名为<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">A96ccA</strong>的这样写道:
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">&nbsp;</p>
<pre><code class="hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;">第一遍：这是啥玩意？<br />第二遍：嗯，还可以<br />第三遍：改革春风吹满地&hellip;<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">可以看出同样的是一首洗脑的音乐。<br />下面让我先来欣赏（再度洗脑）一下。<br />视频地址：https://v.qq.com/x/page/n0806nqulao.html<br />下面就让我们爬取b站上该视频的评论内容,并进行分析为什么这个视频会如此的火。</p>
<h3 id="h" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px; font-weight: bold; border-bottom: 2px solid #3f3f3f; margin-bottom: 50px; font-size: 1em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; background: #3f3f3f; color: #ffffff; padding: 10px 16px; border-radius: 5px; box-shadow: black 5px 5px 10px;"><span style="color: #159957;">. </span>数据下载</span></h3>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">首先我们找到视频:https://www.bilibili.com/video/av19390801.<br />然后找到评论部分,打开谷歌浏览器的控制台，查看network选项的请求信息。通过观察我们发现了这样的链接:<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">https://api.bilibili.com/x/v2/reply?callback=jQuery17204794190151297566_1546432727230&amp;jsonp=jsonp&amp;pn=1&amp;type=1&amp;oid=19390801&amp;sort=0&amp;_=1546432740370</strong><br />去掉没有用的信息最后我们得到最终的url形式为:<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">https://api.bilibili.com/x/v2/reply?pn={pn}&amp;type=1&amp;oid=19390801</strong><br />其中pn为第几页，目前看到评论有1129页，这些数据我们用作简单的数据分析基本够用了。<br />下面就可以编写我们的代码了,这里我采取的是异步网络请求模块aiohttp。然后保存下了每条评论的所以网页可以得到的信息,后期获取每条评论的内容，为后面数据分析使用</p>

<img style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; display: block; margin: 0px auto; max-width: 100%;" title="" src="https://img2018.cnblogs.com/blog/736399/201901/736399-20190102204717542-59963613.gif" alt="" /><br />下面是主要爬取逻辑
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">&nbsp;</p>
<pre><code class="hljs python" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;">base_url&nbsp;=&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"https://api.bilibili.com/x/v2/reply?pn={pn}&amp;type=1&amp;oid=19390801"</span><br /><br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">async</span>&nbsp;<span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">def</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #a5da2d; word-wrap: inherit !important; word-break: inherit !important;">fetch</span><span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ff9823; word-wrap: inherit !important; word-break: inherit !important;">(url)</span>:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">async</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">with</span>&nbsp;sem:&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#并发个数控制</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">async</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">with</span>&nbsp;aiohttp.ClientSession()&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">as</span>&nbsp;session:&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#创建session</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">with</span>&nbsp;async_timeout.timeout(<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ae87fa; word-wrap: inherit !important; word-break: inherit !important;">10</span>):&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#等10s</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">async</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">with</span>&nbsp;session.get(url)&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">as</span>&nbsp;res:&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">await</span>&nbsp;res.json()<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#通过await获取异步过程中的数据</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(data)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">await</span>&nbsp;asyncio.sleep(<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ae87fa; word-wrap: inherit !important; word-break: inherit !important;">2</span>)<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#加个异步等待防止被封。</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">await</span>&nbsp;save_data(glom.glom(data,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"data.replies"</span>))<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#glom模块json数据解析用。</span><br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">这里需要用到以下模块，使用pip install即可安装</p>
<pre><code class="hljs nginx" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-attribute" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">aiohttp</span><br />async_timeout<br />uvloop(windows就不用了，只支持unix系统)<br />glom<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">需要说明的是之前我就是因为没有加等待时间，所以被b站这个接口的链接给封了，造成的现象就是视频可以看但是评论是刷新不出来的，挺有意思的。关于aiohttp的使用方法，有兴趣的朋友可以看我之前写的文章：aiohttp地址放这。<br />到这里数据下载逻辑就完事了，下面是数据存储逻辑。</p>
<h3 id="h-1" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px; font-weight: bold; border-bottom: 2px solid #3f3f3f; margin-bottom: 50px; font-size: 1em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; background: #3f3f3f; color: #ffffff; padding: 10px 16px; border-radius: 5px; box-shadow: black 5px 5px 10px;"><span style="color: #159957;">. </span>数据存储</span></h3>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">因为上面的下载的结果是json格式，所以首先数据库就是mongodb,这里为了统一使用了异步mongo数据模块motor，一个基于事件循环的模块。<br />首先创建数据链接</p>
<pre><code class="hljs ruby" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-class" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">class</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #a5da2d; word-wrap: inherit !important; word-break: inherit !important;">MotorBase</span>:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;_db&nbsp;=&nbsp;{}<br />&nbsp;&nbsp;&nbsp;&nbsp;_collection&nbsp;=&nbsp;{}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">def</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #a5da2d; word-wrap: inherit !important; word-break: inherit !important;">__init__</span><span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ff9823; word-wrap: inherit !important; word-break: inherit !important;">(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>,&nbsp;loop=None)</span></span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>.motor_uri&nbsp;=&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">''</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>.loop&nbsp;=&nbsp;loop&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">or</span>&nbsp;asyncio.get_event_loop()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">def</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #a5da2d; word-wrap: inherit !important; word-break: inherit !important;">client</span><span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ff9823; word-wrap: inherit !important; word-break: inherit !important;">(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>,&nbsp;db)</span></span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>.motor_uri&nbsp;=&nbsp;f<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"mongodb://localhost:27017/{db}"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;AsyncIOMotorClient(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>.motor_uri,&nbsp;io_loop=<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>.loop)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">def</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #a5da2d; word-wrap: inherit !important; word-break: inherit !important;">get_db</span><span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ff9823; word-wrap: inherit !important; word-break: inherit !important;">(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>,&nbsp;db=<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'weixin_use_data'</span>)</span></span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;db&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">not</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">in</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>.<span class="hljs-symbol" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ae87fa; word-wrap: inherit !important; word-break: inherit !important;">_db:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>._db[db]&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>.client(db)[db]<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">self</span>._db[db]<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">这里使用模块有：</p>
<pre><code class="hljs nginx" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-attribute" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">asyncio</span><br />motor<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">然后开始使用类似pymongo的方式插入数据，具体代码如下</p>
<pre><code class="hljs python" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">async</span>&nbsp;<span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">def</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #a5da2d; word-wrap: inherit !important; word-break: inherit !important;">save_data</span><span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ff9823; word-wrap: inherit !important; word-break: inherit !important;">(items)</span>:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;mb&nbsp;=&nbsp;MotorBase().get_db(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'weixin_use_data'</span>)&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#获取链接对象，weixin_use_data是我的数据库名。</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;item&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">in</span>&nbsp;items:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">try</span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">await</span>&nbsp;mb.bilibili_comments.update_one({<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'rpid'</span>:&nbsp;item.get(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"rpid"</span>)},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'$set'</span>:&nbsp;item},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;upsert=<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">True</span>)<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#bilibili_comments是我的表名,update_one方法的作用是不存在就插入存在更新。</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">except</span>&nbsp;Exception&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">as</span>&nbsp;e:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"数据插入出错"</span>,&nbsp;e.args,<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"此时的item是"</span>,item)<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">然后通过执行这个事件循环,事件循环是这里所有异步的基础。</p>
<pre><code class="hljs coffeescript" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">loop</span>&nbsp;=&nbsp;asyncio.get_event_loop()<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#创建一个事件循环</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">loop</span>.run_until_complete(get_data())<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#开始运行直到程序结束</span><br /></code></pre>
<h3 id="h-2" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px; font-weight: bold; border-bottom: 2px solid #3f3f3f; margin-bottom: 50px; font-size: 1em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; background: #3f3f3f; color: #ffffff; padding: 10px 16px; border-radius: 5px; box-shadow: black 5px 5px 10px;"><span style="color: #159957;">. </span>数据解析</span></h3>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">上面我们拿到了作出数据，但是数据都是json格式的，而且量很大，我们需要的只有评论内容，所以我们需要进一步对数据进行处理,同样的这里我也使用了文件读写异步模块aiofiles<br />。<br />这部分代码量也很少，用法和open file差不多，多了些异步的形式而已。<br />首先读取mongo里的数据</p>
<pre><code class="hljs python" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">async</span>&nbsp;<span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">def</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #a5da2d; word-wrap: inherit !important; word-break: inherit !important;">get_data</span><span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ff9823; word-wrap: inherit !important; word-break: inherit !important;">()</span>:</span><br />&nbsp;&nbsp;&nbsp;&nbsp;mb&nbsp;=&nbsp;MotorBase().get_db(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'weixin_use_data'</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;data=mb.bilibili_comments.find()<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;data<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">读取还是用的motor模块为了配合后面的文件读入使用。</p>
<pre><code class="hljs cs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-function" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">async</span>&nbsp;def&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #a5da2d; word-wrap: inherit !important; word-break: inherit !important;">m2f</span>():<br />&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;</span>=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">await</span>&nbsp;get_data()<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">async</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;item&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">in</span>&nbsp;data:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;item.<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">get</span>(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"content"</span>).<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">get</span>(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"message"</span>).strip()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fs&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">await</span>&nbsp;aiofiles.open(pathlib.Path.joinpath(pathlib.Path.cwd().parent,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">"msg.txt"</span>),&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'a+'</span>)<span class="hljs-meta" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #5bdaed; word-wrap: inherit !important; word-break: inherit !important;">#pathlib路径拼接</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">await</span>&nbsp;fs.write(t)<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">到目前为止数据获取部分基本结束了，后面就是对上面的文本文件进行分析了。</p>
<h3 id="h-3" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px; font-weight: bold; border-bottom: 2px solid #3f3f3f; margin-bottom: 50px; font-size: 1em;"><span style="font-size: inherit; line-height: inherit; margin: 0px; display: inline-block; background: #3f3f3f; color: #ffffff; padding: 10px 16px; border-radius: 5px; box-shadow: black 5px 5px 10px;"><span style="color: #159957;">. </span>数据分析</span></h3>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">为了清晰的表达数据所带来的信息，对于评论信息，我们选用直观的方式--词云图</p>
<h4 id="h-4" style="color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px; font-weight: bold; font-size: 1.2em;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">准备工作</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;"><strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">安装包</strong></p>
<pre><code class="hljs nginx" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-attribute" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">jieba</span><br />wordcloud<br />matplotlib<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;"><strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">生成词云需要用的图</strong></p>
<img style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; display: block; margin: 0px auto; max-width: 100%;" title="" src="https://img2018.cnblogs.com/blog/736399/201901/736399-20190102212121022-232427276.jpg" alt="" /><br /><strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">字体文件</strong><br />mac中默认字体显示乱码，这里指定了别的字体msyhbd.ttf，网上随便搜了一个，windows可以或其他系统支持字体即可<br /><strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">停用词设置</strong><br />经过分析大概设置了如下停用词：
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">&nbsp;</p>
<pre><code class="hljs" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;">哈<br />哈哈<br />哈哈哈<br />xa0<br />一个<br />u3000<br />什么<br />视频<br />这个<br />up<br />看到<br />怎么<br />播放<br />真的<br />知道<br />已经<br />改革<br />春风<br />满地<br />鬼畜<br />抖音<br />现在<br />春晚<br />千万<br />助攻<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">停用词设置是为了去除一些没有意义的词，比如这个，那个之类的。或者当前文件的标题<br /><strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">代码如下</strong></p>
<pre><code class="hljs python" style="overflow-wrap: break-word; margin: 0px 2px; line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; color: #a9b7c6; background: #282b2e; overflow-x: auto; padding: 0.5em; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important;"><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;-*-&nbsp;coding:&nbsp;utf-8&nbsp;-*-</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;@Time&nbsp;:&nbsp;2019/1/2&nbsp;7:52&nbsp;PM</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;@Author&nbsp;:&nbsp;cxa</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;@File&nbsp;:&nbsp;cutword.py</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;@Software:&nbsp;PyCharm</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;coding=utf-8</span><br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">import</span>&nbsp;jieba<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">import</span>&nbsp;matplotlib.pyplot&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">as</span>&nbsp;plt<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">from</span>&nbsp;wordcloud&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">import</span>&nbsp;WordCloud<br /><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;获取所有评论</span><br />comments&nbsp;=&nbsp;[]<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">with</span>&nbsp;open(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'msg.txt'</span>,&nbsp;mode=<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'r'</span>,&nbsp;encoding=<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'utf-8'</span>)&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">as</span>&nbsp;f:<br />&nbsp;&nbsp;&nbsp;&nbsp;rows&nbsp;=&nbsp;f.readlines()<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">for</span>&nbsp;row&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">in</span>&nbsp;rows:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comments.append(row)<br /><br /><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;设置分词</span><br />comment_after_split&nbsp;=&nbsp;jieba.cut(str(comments),&nbsp;cut_all=<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #f82375; word-wrap: inherit !important; word-break: inherit !important;">False</span>)&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#分词，cut_all=false</span><br />words&nbsp;=&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'&nbsp;'</span>.join(comment_after_split)&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;以空格进行拼接</span><br /><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;设置屏蔽词</span><br />STOPWORDS&nbsp;=&nbsp;set(map(str.strip,&nbsp;open(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'stopwords'</span>).readlines()))<br />print(STOPWORDS)<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;导入背景图</span><br />bg_image&nbsp;=&nbsp;plt.imread(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'1.jpeg'</span>)<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;设置词云参数，参数分别表示：画布宽高、背景颜色、背景图形状、字体,屏蔽词、最大词的字体大小</span><br />wc&nbsp;=&nbsp;WordCloud(width=<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ae87fa; word-wrap: inherit !important; word-break: inherit !important;">2024</span>,&nbsp;height=<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ae87fa; word-wrap: inherit !important; word-break: inherit !important;">1400</span>,&nbsp;background_color=<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'white'</span>,&nbsp;mask=bg_image,font_path=<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'msyhbd.ttf'</span>,stopwords=STOPWORDS,&nbsp;max_font_size=<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ae87fa; word-wrap: inherit !important; word-break: inherit !important;">400</span>,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;random_state=<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #ae87fa; word-wrap: inherit !important; word-break: inherit !important;">50</span>)<br /><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;将分词后数据传入云图</span><br />wc.generate_from_text(words)<br />plt.imshow(wc)<br />plt.axis(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'off'</span>)&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;不显示坐标轴</span><br />plt.show()<br /><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #808080; word-wrap: inherit !important; word-break: inherit !important;">#&nbsp;保存结果到本地</span><br />wc.to_file(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #eedc70; word-wrap: inherit !important; word-break: inherit !important;">'ggcfcmd.jpg'</span>)<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;"><strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;">最终结果</strong></p>
<img style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; display: block; margin: 0px auto; max-width: 100%;" title="" src="https://img2018.cnblogs.com/blog/736399/201901/736399-20190108214857190-1413425668.jpg" alt="" /><br />由此可以看出这视频最重要的还是洗脑，导致进来就出不去了，同样的也是追忆本山大叔多年来带给大家的无数快乐时光，总之洗脑就完事了。
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">&nbsp;</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">为了方便大家的阅读代码，本文中所有涉及到的代码，已经传到https://github.com/muzico425/bilibilianalysis.git</p>
<p>一直以为这个视频是年底的时候才开始传播的，然而事情并不是这样。。。</p>
<h3 id="h">评论发布时间分析</h3>
<h4 id="hmongodb">从mongodb中抽取评论时间</h4>
<p>分析了之前爬取的json数据，其中每一组有一个ctime参数，根据经验可知这是一个时间戳,<br />于是使用tool文件夹下的mongo_to_csv.py文件的get_ctime方法取出每一条记录的时间戳，同时转换成年月日的形式存入到ctime.txt文件中。对后续的操作作准备。</p>
<h4 id="h-1">对时间排序并计数</h4>
<p>这一步核心代码如下</p>
<pre><code class="hljs python"><span class="hljs-keyword">from&nbsp;collections&nbsp;<span class="hljs-keyword">import&nbsp;Counter,&nbsp;Mapping<br /><span class="hljs-keyword">from&nbsp;operator&nbsp;<span class="hljs-keyword">import&nbsp;itemgetter<br /><span class="hljs-keyword">with&nbsp;open(<span class="hljs-string">"ctime.txt")&nbsp;<span class="hljs-keyword">as&nbsp;fs:<br />&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;(i.strip()&nbsp;<span class="hljs-keyword">for&nbsp;i&nbsp;<span class="hljs-keyword">in&nbsp;fs.readlines())<br />d&nbsp;=&nbsp;dict(sorted(Counter(data).items(),&nbsp;key=itemgetter(<span class="hljs-number">0)))<br />print(d)<br /></span></span></span></span></span></span></span></span></span></span></code></pre>
<p>首先，读取文件循环去除换行符，生成新的数据，生成的是个生成器对象，目的是省内存。<br />然后调用python标准库的collections模块的Counter方法，做一个计数参做，因为isinstance(Counter,Mapping)会输出True，可知其属于映射类型，因此有着类似字典的方法，于是对该对象做一个排序,其中这里的key=itemgetter(0),表示按照第一个元素排序,<br />itemgetter来自python标准库的operator模块,之后转换成字典，为后面的数据显示作准备。<br />最后的结果如下：</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 1.5em 0px;">
<img title="" src="https://mmbiz.qlogo.cn/mmbiz_png/MhvFx9xtQicY4kwwpg1lbJN2Gicm3bcldbR6FPGr5WHLGLxice2Y02ETA4eMfDCibvyiarGny9seYAFtumqwLzicqDZA/0?wx_fmt=png" alt="" data-ratio="0.5" data-w="800" data-type="png" /><br />我们可以发现评论开始日期是从2018-02-11开始的,一开始我也没有去注意视频的发布时间，我以为分析错了呢，赶紧去看了一眼视频，还真是 2018-2-11发布<br /><img title="" src="https://mmbiz.qlogo.cn/mmbiz_png/MhvFx9xtQicY4kwwpg1lbJN2Gicm3bcldbTI20DqiataLKlY92e4EFyTaAGP9BCAXXD10XZgPma2FU09UQ9V7t3Wg/0?wx_fmt=png" alt="" data-ratio="0.7217280813214739" data-w="1574" data-type="png" /><br />然后评论数越来越少，然后到11左右再次上来了,为了知道原因,我去翻阅了下该段时间评论大致知道了,由于抖音的传播和微博的传播，以其后来bgm成了微博的热搜关键字，也就是不难想象这段时间评论量的上升了，其实大家还可以对这段时间的评论内容做个词云分析，去看关键字，或者去做个情感分析。这就交给大家去完成了。</p>
<p>&nbsp;</p>
<h3 id="h-2">总结</h3>
<p>通过这次对评论内容以及时间的分析，尤其是评论数的时间，真正的感受到了数据分析的乐趣。好了本次的内容就结束了，希望大家能够喜欢。</p>
</div>
